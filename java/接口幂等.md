# 接口幂等

### 需要接口幂等的原因
- 网络波动, 可能会引起重复请求
- 用户重复操作,用户在操作时候可能会无意触发多次下单交易,甚至没有响应而有意触发多次交易
- 应用使用了失效或超时重试机制(Nginx重试、RPC重试或业务层重试等)
- 页面重复刷新
- 使用浏览器后退按钮重复之前的操作,导致重复提交表单
- 使用浏览器历史记录重复提交表单
- 浏览器重复的HTTP请求
- 定时任务重复执行
- 用户双击提交按钮

### 接口幂等的含义
以相同的请求调用这个接口一次和调用这个接口多次，对系统产生的影响是相同的。

### 幂等和不幂等的场景举例
1. 抢红包的接口：需要保证接口幂等，一个人对一个红包只能抢一次
2. 库存扣减接口：需要保证接口幂等。
3. 创建订单的接口：需要保证接口幂等。第一次调用返回超时了，重试机制一般会再次调用这个接口，此时我们不能因为这个接口被调了两次就创建两个一样的订单；
4. 订单支付接口：需要保证接口幂等。

查询操作：天然幂等。查询一次和查询多次，在数据不变的情况下，查询结果是一样的。select是天然的幂等操作；
删除操作：幂等。删除操作也是幂等的，删除一次和多次删除都是把数据删除。(注意可能返回结果不一样，删除的数据不存在，返回0，删除的数据多条，返回结果多个) ；
更新操作：幂等的更新：update table set status = -1 where id = 1 
        不幂等的更新：update table set number = number+1 where id = 1 
插入操作：不幂等，多次插入会产生多条一样的数据

并不是所有接口都需要保证幂等性。需不需要保证接口幂等，要看具体的业务场景来判断。

### 实现接口幂等的方案
1. 前端或者客户端控制，按钮只能按一次

2. token机制
流程：
2.1 服务端提供了发送token的接口。调用方在执行业务前，先去获取token，服务器会先生成token并保存到redis中，然后返回给调用方
2.2 调用方调用业务接口请求，把token携带过去，一般放在请求头部。
2.3 服务器判断token是否存在redis中，存在表示第一次请求，这时把redis中的token删除，继续执行业务。不存在则表示重复操作，直接返回重复标记给调用方。

3. 唯一索引
适用于insert。比如支付宝每个用户只可以生成一个资金账户，则在资金账户表中将用户id设为唯一索引

4. 去重表
这种方法适用于在业务中有唯一标志的插入场景中，比如在支付场景中，如果一个订单只会支付一次，所以订单ID可以作为唯一标识。
这时，我们就可以新建一张去重表，并且把唯一标识作为唯一索引，在我们实现时，把创建支付单据和写入去去重表，放在一个事务中，如果重复创建，数据库会抛出唯一约束异常，操作就会回滚。

5. 乐观锁
适用于update。update table set count=#{count},version = version+1 where version = #{version}

6. 分布式redis锁
将用户id+后缀 设置为redis锁的key，要操作业务需要先获得对应的锁

7. 状态机
适用于update,比如业务上需要修改订单状态,例如订单状态有待支付、支付中、支付成功、支付失败、订单超时关闭等,在设计的时候最好只支持状态的单向改变(不可逆),
假设当前状态是支付成功，这时候如果支付接口又接收到了支付请求，则会抛异常或拒绝此次处理。

8. 业务逻辑修改
当用户点击赞同时，将答案的赞同数量+1。
改为：
当用户点击赞同时，确保答案赞同表中存在一条记录，用户、答案。
赞同数量由答案赞同表统计出来。
